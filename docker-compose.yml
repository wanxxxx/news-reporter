version: '3.8'

services:
  news_reporter:
    image: openclaw-feishu:v1
    container_name: news_reporter
    
    environment:
      # ==========================================
      # ä»£ç†é…ç½® - é€šè¿‡ host.docker.internal è®¿é—®å®¿ä¸»æœºçš„ VPN
      # æ ¹æ®ä½ çš„ VPN è½¯ä»¶ä¿®æ”¹ç«¯å£ (å¸¸è§: 7890, 1080, 8080)
      # ==========================================
      - HTTP_PROXY=http://host.docker.internal:7890
      - HTTPS_PROXY=http://host.docker.internal:7890
      - ALL_PROXY=socks5://host.docker.internal:7890
      
      # ==========================================
      # å…¶ä»–é…ç½®
      # ==========================================
      - TZ=Asia/Shanghai
      - PYTHONUNBUFFERED=1
      - PYTHONIOENCODING=utf-8
      
    # ç›´æ¥ä» .env æ–‡ä»¶åŠ è½½æ‰€æœ‰é…ç½®
    env_file:
      - .env
      
    volumes:
      # SSH å¯†é’¥ - ä»å®¿ä¸»æœºæŒ‚è½½ï¼ˆè·¯å¾„ä»ç¯å¢ƒå˜é‡ SSH_KEY_PATH è¯»å–ï¼‰
      # æ³¨æ„ï¼šéœ€è¦æŒ‚è½½ç§é’¥æ–‡ä»¶ï¼ˆä¸æ˜¯ .pub æ–‡ä»¶ï¼‰
      - ${SSH_KEY_PATH}:/tmp/host_ssh_key:ro
      
      # ä¿å­˜ openclaw å·¥ä½œç©ºé—´ï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦ä¿æŒç™»å½•çŠ¶æ€ï¼‰
      - news_reporter_openclaw:/root/.openclaw/workspace
      
    # å·¥ä½œç›®å½•
    working_dir: /app
    
    # ä¿æŒå®¹å™¨è¿è¡Œï¼Œæ–¹ä¾¿æ‰‹åŠ¨æ‰§è¡Œ
    stdin_open: true
    tty: true
    
    # å¯åŠ¨è„šæœ¬ - å†…è”è„šæœ¬ï¼Œè‡ªåŠ¨æ‹‰å–ä»£ç å¹¶å®‰è£…ä¾èµ–
    command:
      - bash
      - -c
      - |
        set -e
        
        APP_DIR="/app/news_reporter"
        GIT_REPO_SSH="git@github.com:wanxxxx/news-reporter.git"
        GIT_REPO_HTTPS="https://github.com/wanxxxx/news-reporter.git"
        
        echo "=========================================="
        echo "ğŸš€ News Reporter å®¹å™¨å¯åŠ¨è„šæœ¬"
        echo "=========================================="
        
        # é…ç½® SSH å¯†é’¥æƒé™
        if [ -f "/tmp/host_ssh_key" ]; then
            echo "ğŸ”‘ é…ç½® SSH å¯†é’¥..."
            mkdir -p /root/.ssh
            chmod 700 /root/.ssh
            cp /tmp/host_ssh_key /root/.ssh/id_ed25519
            chmod 600 /root/.ssh/id_ed25519
            ssh-keyscan github.com >> /root/.ssh/known_hosts 2>/dev/null
            chmod 644 /root/.ssh/known_hosts
            echo "âœ… SSH å¯†é’¥é…ç½®å®Œæˆ"
            USE_SSH=true
        else
            echo "âš ï¸ æœªæ‰¾åˆ° SSH å¯†é’¥ï¼Œå°†ä½¿ç”¨ HTTPS æ–¹å¼å…‹éš†"
            USE_SSH=false
        fi
        
        # æ£€æŸ¥æ˜¯å¦å·²ç»å…‹éš†è¿‡ä»“åº“
        if [ -d "$APP_DIR/.git" ]; then
            echo "ğŸ“¦ ä»“åº“å·²å­˜åœ¨ï¼Œæ­£åœ¨æ‹‰å–æœ€æ–°ä»£ç ..."
            cd "$APP_DIR"
            git pull origin main || echo "âš ï¸ Git pull å¤±è´¥ï¼Œä½¿ç”¨ç°æœ‰ä»£ç "
        else
            echo "ğŸ“¦ å…‹éš†ä»“åº“..."
            if [ "$$USE_SSH" = true ]; then
                echo "ğŸ”— ä½¿ç”¨ SSH æ–¹å¼å…‹éš†..."
                git clone "$$GIT_REPO_SSH" "$$APP_DIR" || {
                    echo "âš ï¸ SSH å…‹éš†å¤±è´¥ï¼Œå°è¯• HTTPS..."
                    git clone "$$GIT_REPO_HTTPS" "$$APP_DIR"
                }
            else
                echo "ğŸ”— ä½¿ç”¨ HTTPS æ–¹å¼å…‹éš†..."
                git clone "$$GIT_REPO_HTTPS" "$$APP_DIR"
            fi
        fi
        
        cd "$APP_DIR"
        
        # å®‰è£… pipï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if ! python3 -m pip --version > /dev/null 2>&1; then
            echo "ğŸ“¦ å®‰è£… pip..."
            apt-get update -qq && apt-get install -y -qq python3-pip > /dev/null
        fi
        
        # å®‰è£… Python ä¾èµ–
        echo "ğŸ“¦ å®‰è£… Python ä¾èµ–..."
        python3 -m pip install --quiet --no-cache-dir --break-system-packages \
            feedparser \
            requests \
            beautifulsoup4 \
            trafilatura \
            lxml_html_clean \
            lark-oapi \
            openai \
            python-dotenv
        
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        
        # å¯åŠ¨ openclaw gateway
        echo "ğŸš€ å¯åŠ¨ openclaw gateway..."
        exec openclaw gateway --bind lan --verbose
    
    # ç½‘ç»œé…ç½® - ä½¿ç”¨æ¡¥æ¥ç½‘ç»œï¼Œé€šè¿‡ host.docker.internal è®¿é—®å®¿ä¸»æœº
    extra_hosts:
      - "host.docker.internal:host-gateway"

# å‘½åå· - ä»…ä¿ç•™å¿…è¦çš„
volumes:
  news_reporter_openclaw:
    name: news_reporter_openclaw
